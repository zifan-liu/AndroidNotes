# AndroidManagerService
- ActivityManagerService是Android系统中一个特别重要的系统服务，也是我们上层APP打交道最多的系
统服务之一。ActivityManagerService（以下简称AMS） 主要负责四大组件的启动、切换、调度以及应
用进程的管理和调度工作。所有的APP应用都需要与AMS打交道

#### ActivityManagerService的组成主要分为以下几个部分：
   1. 服务代理：由ActivityManagerProxy实现，用于与Server端提供的系统服务进行进程间通信
   2. 服务中枢：ActivityManagerNative继承自Binder并实现IActivityManager，它提供了服务接口和Binder接口的相互转化功能，并在内部存储服务代理对像，并提供了getDefault方法返回服务代理
   3. Client：由ActivityManager封装一部分服务接口供Client调用。ActivityManager内部通过调用
ActivityManagerNative的getDefault方法，可以得到一个ActivityManagerProxy对像的引用，进而通过
该代理对像调用远程服务的方法
   4. Server:由ActivityManagerService实现，提供Server端的系统服务

## ActivityManagerService的启动过程
- AMS是在SystemServer中被添加的， 所以先到SystemServer中查看初始化
#### 1. SystemServer进程启动

- SystemServer.main 初始化SystemServer对象，再调用对象的run()方法
    > createSystemContext() 初始化系统上下文
    > startBootstrapServices 启动引导服务 (在这当中启动了AMS) 
    > startCoreServices 启动核心服务
    > startOtherServices 启动其他服务
    > Looper.loop 进入loop循环


#### 2. AMS启动过程
1. 入口为SystemServer.startBootstrapServices()
    ```java
    // Android10 中新增ATMS
    ActivityTaskManagerService atm = mSystemServiceManager.startService(
            ActivityTaskManagerService.Lifecycle.class).getService();
    mActivityManagerService = ActivityManagerService.Lifecycle.startService(
            mSystemServiceManager, atm);
    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
    mActivityManagerService.setInstaller(installer);
    mWindowManagerGlobalLock = atm.getGlobalLock();
    ```
-  ActivityManagerService.Lifecycle.startService(mSystemServiceManager, ATMS) ->
    - ActivityManagerService.Lifecycle.Cunstructor() ->
        -  mService = new ActivityManagerService(context, sAtm); // 1.创建对象
    - SystemServiceManager.addService<SystemService>(ActivityManagerService.Lifecycle)// 2.加入到ssm的集合中保存Lifecycle对象
    - mService.start() // 3.执行start()

2. new ActivityManagerService(context, ATMS)创建AMS
-  创建"android.ui"的线程
-  创建ActiveServices
-  创建ActivityStackSupervisor对象

3. AMS.start()
- 移除所有的进程组
- 启动CpuTracker线程
- 启动电池统计服务
- 创建LocalService，并添加到LocalServices